<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureLang Logs (SLL)</title>
    <link rel="stylesheet" href="/css/style.css">

<!-- ############################################################################################################### -->
</head>
<body>
    <header class="page-header">
        <h2>SecureLang Logs (SLL)</h2>
    </header>


    <div class="chat-container">
        <div class="chat-window">
            <div class="chat-message bot">
                <p>Hi, how can I assist you today?</p>
            </div>
        </div>
        <div class="predefined-questions-c" id="predefined-questions">     <!---Man kan bara lägga till fler så många frågor man nu vill ha. Den skickar sedan knapp trycket som ett vanligt meddelande-->
            <button class="question-btn">Button1</button>
            <button class="question-btn">Button2</button>
            <button class="question-btn">Button3</button>
        </div>
        <div class="chat-input">
            <input type="text" placeholder="Type your message..." id="message-input">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <footer class="page-footer">
        <p>&copy; 2024 SecureLang Logs (SLL)</p>
    </footer>

    <script>
        // Check if the token exists, otherwise redirect to login
        function checkAuth() {
            if (!document.cookie.includes('token')) {
                window.location.href = '/login.html';  // Redirect to login page
            }
        }
        // Run check on page load
        // window.onload = checkAuth; // this will check for token before page loads.

        // Add chat functionality (similar to the original one)
        const sendBtn = document.getElementById('send-btn');
        const messageInput = document.getElementById('message-input');
        const chatWindow = document.querySelector('.chat-window');
        const predefinedQuestions = document.getElementById('predefined-questions');

        predefinedQuestions.addEventListener('click', async (event) => {
            if (event.target.classList.contains('question-btn')) {
                const question = event.target.textContent;
                
                // Skicka frågan som ett användarmeddelande
                const userMsgDiv = document.createElement('div');
                userMsgDiv.classList.add('chat-message', 'user');
                userMsgDiv.innerHTML = `<p>${question}</p>`;
                chatWindow.appendChild(userMsgDiv);

                // Fetch från API:et som vanligt
                const response = await fetch('chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: question }),
                    credentials: 'include',
                });

                const result = await response.json();

                const botMsgDiv = document.createElement('div');
                botMsgDiv.classList.add('chat-message', 'bot');
                botMsgDiv.innerHTML = `<p>${response.ok ? result.response : `Error: ${result.error}`}</p>`;
                chatWindow.appendChild(botMsgDiv);

                // Rulla till botten och dölja frågeknapparna
                chatWindow.scrollTop = chatWindow.scrollHeight;
                predefinedQuestions.style.display = 'none';
            }
        });


        sendBtn.addEventListener('click', async () => {
            const userMessage = messageInput.value;
            if (userMessage.trim()) {
                const userMsgDiv = document.createElement('div');
                userMsgDiv.classList.add('chat-message', 'user');
                userMsgDiv.innerHTML = `<p>${userMessage}</p>`;
                chatWindow.appendChild(userMsgDiv);


                const response = await fetch('chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage }),
                credentials: 'include',  // Add this line to include cookies
                });

                const result = await response.json();

                if (response.ok) {
                    const botMsgDiv = document.createElement('div');
                    botMsgDiv.classList.add('chat-message', 'bot');
                    
                    const answerArr = result.response.split("\n");
                    let multiLineAnswer = "";
                    
                    for (let i of answerArr){
                        multiLineAnswer += `<p>${i}</p>`;
                    }

                    botMsgDiv.innerHTML = multiLineAnswer//`<p>${result.response}</p>`;
                    chatWindow.appendChild(botMsgDiv);
                } else {
                    const botMsgDiv = document.createElement('div');
                    botMsgDiv.classList.add('chat-message', 'bot');
                    botMsgDiv.innerHTML = `<p>Error: ${result.error}</p>`;
                    chatWindow.appendChild(botMsgDiv);
                }

                messageInput.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;
                predefinedQuestions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
